---
lab:
  az204Title: 'Lab 07: Access resource secrets more securely across services'
  az204Module: 'Learning Path 07: Implement secure Azure solutions'
---

# Laboratório 07: Acesse segredos de recursos com mais segurança em todos os serviços

## Interface de usuário do Microsoft Azure

Dada a natureza dinâmica das ferramentas de nuvem da Microsoft, você pode se deparar com alterações na IU do Azure que ocorram após o desenvolvimento deste conteúdo do treinamento. Como resultado, as instruções do laboratório e as etapas do laboratório podem não estar alinhadas corretamente.

A Microsoft atualiza este curso de treinamento quando a comunidade chama a nossa atenção para alterações necessárias. No entanto, como as atualizações na nuvem ocorrem com frequência, você pode encontrar alterações na interface de usuário antes que esse conteúdo de treinamento seja atualizado. **Se isso ocorrer, adapte-se às alterações e trabalhe com elas nos laboratórios, conforme necessário.**

## Instruções

### Antes de começar

#### Entrar no ambiente de laboratório

Entre na máquina virtual (VM) do Windows 10 usando as seguintes credenciais:

- Nome de usuário: `Admin`
- Senha: `Pa55w.rd`

> **Observação**: Seu instrutor fornecerá instruções para se conectar ao ambiente de laboratório virtual.

#### Examinar os aplicativos instalados

Encontre a barra de tarefas na área de trabalho do Windows 10. A barra de tarefas contém os ícones dos aplicativos que você usará neste laboratório, incluindo:

- Microsoft Edge
- Explorador de Arquivos
- Terminal do Windows
- Visual Studio Code

## Cenário do laboratório

Neste laboratório, você criará uma conta de armazenamento e um aplicativo de funções do Azure que acessará a conta de armazenamento. Para demonstrar o armazenamento seguro de informações de cadeia de conexão, você provisionará um recurso do Key Vault e gerenciará os segredos apropriados para armazenar as informações da cadeia de conexão. Você também gerenciará a identidade do serviço para obter acesso seguro às informações da cadeia de conexão da conta de armazenamento.

## Diagrama de arquitetura

![Diagrama de arquitetura que mostra um usuário acessando segredos de recursos com mais segurança entre os serviços.](./media/Lab07-Diagram.png)

### Exercício 1: Criar recursos do Azure

#### Tarefa 1: Abrir o portal do Azure

1. Na barra de tarefas, selecione o ícone **Microsoft Edge**.

1. Na janela aberta do navegador, navegue até o portal do Azure em `https://portal.azure.com` e entre com a conta que você usará para este laboratório.

   > **Observação**: Se esta for a primeira vez que entra no portal do Azure, você receberá um tour pelo portal. Selecione **Introdução** para ignorar o tour e começar a usar o portal.

#### Tarefa 2: Criar uma conta de armazenamento

1. No portal do Azure, use a caixa de texto **Pesquisar recursos, serviços e documentos** para procurar por **Contas de armazenamento** e, na lista de resultados, selecione **Contas de armazenamento**.

1. Na folha **Contas de armazenamento** , selecione **+ Criar**.

1. Na folha **Criar uma conta de armazenamento**, na guia **Básico**, realize as ações a seguir e selecione **Examinar**:

   | Configuração                           | Ação                                                                     |
   | --------------------------------- | -------------------------------------------------------------------------- |
   | **Assinatura** lista suspensa   | Manter o valor padrão                                                   |
   | Seção **Grupo de recursos**        | Selecionar **Criar novo**, inserir **ConfidentialStack** e selecionar **OK** |
   | Caixa de texto **Nome da conta de armazenamento**  | Inserir **securestor**_[yourname]_                                           |
   | Lista suspensa **Região**         | Selecione **(EUA) Leste dos EUA**                                                    |
   | Seção **Desempenho**           | Selecione a opção **Padrão**                                             |
   | Lista suspensa **Redundância**     | Selecione **LRS (armazenamento com redundância local)**                                 |

   A captura de tela a seguir exibe as configurações definidas na folha **Criar uma conta de armazenamento**.

   ![Captura de tela exibindo as configurações definidas na folha Criar uma conta de armazenamento](./media/l07_create_a_storage_account.png)

1. Na guia **Revisão**, revise as opções selecionadas nas etapas anteriores.

1. Selecione **Criar** para criar a conta de armazenamento usando a configuração especificada.

   > **Observação**: Aguarde a conclusão da tarefa de criação antes de avançar neste laboratório.

1. Na folha **Visão Geral de implantação**, selecione **Ir para o recurso**.

1. Na folha **Conta de armazenamento** , na seção  **Segurança + rede** , selecione o link **Chaves de acesso** .

1. Na seção **Chaves de acesso** , selecione **Mostrar chaves**.

1. Selecione qualquer uma das chaves e registre o valor em uma das caixas  **Cadeia de conexão** . Você usará esse valor mais adiante no laboratório.

   > **Observação**: Não importa qual cadeia de conexão você escolher. Elas são intercambiáveis.

#### Tarefa 3: Criar um Azure Key Vault

1. No portal do Azure, use a caixa de texto **Pesquisar recursos, serviços e documentos** para procurar por **Cofres de chaves** e, na lista de resultados, selecione **Cofres de chaves**.

1. Na folha **Cofres de chaves**, selecione **Criar**.

1. Na folha **Criar cofre de chaves**, na guia **Básico**, realize as seguintes ações e selecione **Revisar + Criar**:

   | Configuração                           | Ação                                   |
   | --------------------------------- | ---------------------------------------- |
   | **Assinatura** lista suspensa   | Manter o valor padrão                 |
   | Lista suspensa **Grupo de recursos** | Selecionar **ConfidentialStack** na lista |
   | Caixa de texto **Nome do cofre de chaves**        | Inserir **securevault**_[yourname]_        |
   | Lista suspensa **Região**         | Selecione **Leste dos EUA**                       |
   | Lista suspensa **Tipo de preço**   | Selecione **Standard**                      |

1. Navegue até a guia **Configuração de acesso** e altere o modelo de permissão para **Política de acesso do cofre**.

   A captura de tela a seguir exibe as configurações definidas na folha **Criar cofre de chaves**.

   ![Captura de tela exibindo as configurações definidas na folha Criar cofre de chaves](./media/l07_create_key_vault.png)

1. Na guia **Revisar + criar**, revise as opções selecionadas nas etapas anteriores.

1. Selecione **Criar** para criar o cofre de chaves usando a configuração especificada.

   > **Observação**: Aguarde a conclusão da tarefa de criação antes de avançar neste laboratório.

#### tarefa 4: Criar um aplicativo de funções

1. No portal do Azure, use a caixa de texto **Pesquisar recursos, serviços e documentos** para procurar por **Aplicativo de funções** e, na lista de resultados, selecione **Aplicativo de funções**.

1. Na folha **Aplicativo de funções**, selecione **Criar**.

1. Na folha **Criar aplicativo de funções**, na guia **Básico**, realize as seguintes ações e selecione **Avançar: Armazenamento**:

   | Configuração                           | Ação                              |
   | --------------------------------- | ----------------------------------- |
   | **Assinatura** lista suspensa   | Manter o valor padrão            |
   | Lista suspensa **Grupo de recursos** | Selecionar **ConfidentialStack**        |
   | Caixa de texto **Nome do aplicativo de funções**     | Inserir **securefunc**_[yourname]_    |
   | Seção **Publicar**               | Selecione **Código**                     |
   | Lista suspensa**Pilha de runtime**  | Selecionar **.NET**                     |
   | Lista suspensa **Versão**        | Selecionar **6**                        |
   | Lista suspensa **Região**         | Selecionar a região **Leste dos EUA**       |
   | Seção **Sistema operacional**      | Selecione **Linux**                    |
   | Lista suspensa **Hosting**        | Selecionar **Consumo (sem servidor)** |

   A captura de tela a seguir exibe as configurações definidas na folha **Criar aplicativo de funções**.

   ![Captura de tela exibindo as configurações definidas na folha Criar aplicativo de funções](./media/l07_create_function_app.png)

1. Na guia **Armazenamento**, realize as seguintes ações e selecione **Revisar + criar**:

   | Configuração                            | Ação                                                |
   | ---------------------------------- | ----------------------------------------------------- |
   | Lista suspensa **Conta de armazenamento** | Selecionar a conta de armazenamento **securestor**_[yourname]_ |

1. Na guia **Revisar + criar**, revise as opções selecionadas nas etapas anteriores.

1. Selecione **Criar** para criar o aplicativo de funções usando a configuração especificada.

   > **Observação**: Aguarde a conclusão da tarefa de criação antes de avançar neste laboratório.

#### Revisão

Neste exercício, você criou todos os recursos que usará neste laboratório.

### Exercício 2: Configurar segredos e identidades

#### tarefa 1: Configurar uma identidade de serviço gerenciada atribuída pelo sistema

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o aplicativo de funções **securefunc**_[yourname]_.

   > **Observação**: Haverá dois recursos, um aplicativo de funções e um recurso de insights de aplicativo, com o mesmo nome. Certifique-se de selecionar o recurso de aplicativo de funções.

1. Na folha **Aplicativo de funções**, selecione a opção **Identidade** da seção **Configurações**.

1. No painel **Identidade**, na guia **Atribuída pelo sistema**, defina o **Status** como **Ativado** e selecione **Salvar**.

1. Selecione **Sim** para confirmar a configuração.

   > **Observação**: aguarde a identidade gerenciada atribuída pelo sistema ser criada antes de avançar neste laboratório.

#### Tarefa 2: Criar um segredo do Key Vault

1. No painel de **navegação** do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o cofre de chaves **securevault**_[yourname]_.

1. Na folha **Key Vault**, selecione o link **segredos** na seção **Objetos**.

1. No painel **Segredos**, selecione **+ Gerar/Importar**.

1. Na folha **Criar um segredo**, realize as seguintes ações e selecione **Criar**:

   | Configuração                           | Ação                                                                               |
   | --------------------------------- | ------------------------------------------------------------------------------------ |
   | Lista suspensa **Opções de upload** | Selecione **Manual**                                                                    |
   | Caixa de texto **Nome**                 | Inserir **storagecredentials**                                                         |
   | Caixa de texto **Valor secreto**         | Insira a cadeia de conexão da conta de armazenamento salva anteriormente neste laboratório. |
   | Caixa de texto **Tipo de conteúdo**         | Deixar em branco                                                                          |
   | Caixa de seleção **Definir data de ativação** | Não selecionado                                                                         |
   | Caixa de seleção **Definir data de validade** | Não selecionado                                                                         |
   | Opção **Habilitado**                | Selecione **Sim**                                                                       |

   A captura de tela a seguir exibe as configurações definidas na folha **Criar um segredo**.

   ![Captura de tela exibindo as configurações definidas na folha Criar um segredo ](./media/l07_create_a_secret.png)

   > **Observação**: Aguarde o segredo ser criado antes de avançar neste laboratório.

1. Retorne ao painel **Segredos** e selecione o item **storagecredentials** na lista.

1. No painel **Versões**, selecione a última versão do segredo **storagecredentials**.

1. No painel **Versão do segredo**, realize as seguintes ações:

   1. Selecione **Mostrar valor secreto** para encontrar o valor do segredo.

   1. Registre o valor da caixa de texto **Identificador do segredo**, porque você o usará mais adiante no laboratório.

   > **Observação**: Você está registrando o valor da caixa de texto **Identificador do segredo**, e não da caixa de texto **Valor secreto**.

#### Tarefa 3: Configurar uma política de acesso do Key Vault

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o cofre de chaves **securevault[yourname]**.

1. Na folha **Key Vault**, selecione o link **Políticas de acesso** na seção **Visão Geral**.

1. No painel **Políticas de acesso**, selecione **+ Criar**.

1. Na folha **Criar uma política de acesso**, selecione a seção **Permissões** e faça as seleções a seguir:

   | Configuração                                      | Ação                        |
   | -------------------------------------------- | ----------------------------- |
   | Lista suspensa **Configurar com base em um modelo** | Deixar em branco                   |
   | Caixas de seleção **Permissões de chave**               | 0 selecionado                    |
   | Caixas de seleção **Permissões de segredo**            | Selecionar a permissão **GET** |
   | Caixas de seleção **Permissões de certificado**       | 0 selecionado                    |

1. Selecione a seção **Entidade de segurança** e faça as seleções a seguir:

   | Configuração                   | Ação                                                                                                                                                                                                      |
   | ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
   | Link **Selecionar entidade de segurança** | Localize e selecione a entidade de serviço chamada **securefunc**_[yourname]_. A identidade gerenciada atribuída pelo sistema criada anteriormente neste laboratório terá o mesmo nome que o recurso do Azure Functions |

1. Selecione **Revisar + criar** e, então, selecione **Criar**.

   > **Observação**: Aguarde as suas alterações nas políticas de acesso serem salvas antes de avançar neste laboratório.

#### Tarefa 4: Criar uma configuração de aplicativo derivado do Key Vault

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o aplicativo de funções **securefunc[yourname]**.

1. Na folha **Aplicativo de funções**, selecione a opção **Configuração** da seção **Configurações**.

1. No painel **Configuração**, na guia **Configurações do aplicativo**, selecione a configuração **Novo aplicativo**.

1. Na janela pop-up **Adicionar/Editar configuração de aplicativo**, na caixa de texto **Nome**, insira **StorageConnectionString**.

1. Na caixa de texto **Valor**, construa um valor usando a sintaxe a seguir: `@Microsoft.KeyVault(SecretUri=<Secret Identifier>)`, em que o espaço reservado `<Secret Identifier>` representa o identificador de segredo registrado anteriormente neste exercício.

   > **Observação**: Por exemplo, se o seu identificador de segredo for `https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf`, o valor resultante será `@Microsoft.KeyVault(SecretUri=https://securevaultstudent.vault.azure.net/secrets/storagecredentials/17b41386df3e4191b92f089f5efb4cbf)`.

1. Deixe a caixa de seleção **configuração do slot de implantação** definida como seu valor padrão (não selecionado) e selecione **OK** para fechar a janela pop-up e voltar para a seção **Configuração**.

1. Selecione **Salvar** para salvar suas configurações e, então, na caixa de diálogo pop-up de confirmação **Salvar alterações**, selecione **Continuar**.

   > **Observação**: Aguarde até que as configurações do aplicativo sejam salvas antes de avançar no laboratório.

#### Revisão

Neste exercício, você criou uma identidade de serviço gerenciada atribuída pelo sistema para o seu aplicativo de funções e, em seguida, concedeu a essa identidade as permissões apropriadas para obter o valor de um segredo no cofre de chaves. Por fim, você criou um segredo referenciado dentro das definições de configuração do seu aplicativo de funções.

### Exercício 3: Criar um aplicativo do Azure Functions

#### Tarefa 1: Inicializar um projeto de função

1. Na barra de tarefas, selecione o ícone **Terminal do Windows**.

1. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

   > **Observação**: No Windows Explorer, remova o atributo Somente leitura do arquivo gitignore F:\Allfiles\Labs\07\Starter\func\..

1. Execute o seguinte comando para usar **Azure Functions Core Tools** para criar um novo projeto local do Functions no diretório atual usando o runtime **dotnet**:

   ```powershell
   func init --worker-runtime dotnet --force
   ```

   > **Observação**: Você pode examinar a documentação para [create a new project][azure-functions-core-tools-new-project] usando **Azure Functions Core Tools**.

1. Execute o comando a seguir para **criar** o projeto do .NET 6:

   ```powershell
   dotnet build
   ```

#### Tarefa 2: Criar uma função disparada por HTTP

1. Execute o comando a seguir para usar **Azure Functions Core Tools** para criar uma nova função chamada **FileParser** usando o modelo de **gatilho de HTTP**:

   ```powershell
   func new --template "HTTP trigger" --name "FileParser"
   ```

   > **Observação**: você pode examinar a documentação para [create a new function][azure-functions-core-tools-new-function] usando **Azure Functions Core Tools**.

1. Feche o aplicativo **Terminal do Windows** em execução no momento.

#### Tarefa 3: Configurar e ler uma configuração de aplicativo

1. Na tela **inicial**, selecione o bloco **Visual Studio Code**.

1. No menu **Arquivo**, selecione **Abrir Pasta**.

1. Na janela **Explorador de Arquivos** que se abre, navegue até **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func** e selecione **Selecionar Pasta**.

1. No painel **Explorer** da janela do **Visual Studio Code**, abra o arquivo **local.settings.json**.

1. Observe o valor atual do objeto **Valores**:

   ```json
   "Values": {
       "AzureWebJobsStorage": "UseDevelopmentStorage=true",
       "FUNCTIONS_WORKER_RUNTIME": "dotnet"
   }
   ```

1. Atualize o valor do objeto **Valores**, adicionando uma nova configuração chamada **StorageConnectionString** e, em seguida, atribuindo-lhe um valor de cadeia de caracteres de **[TEST VALUE]**:

   ```json
   "Values": {
       "AzureWebJobsStorage": "UseDevelopmentStorage=true",
       "FUNCTIONS_WORKER_RUNTIME": "dotnet",
       "StorageConnectionString": "[TEST VALUE]"
   }
   ```

1. O arquivo **local.settings.json** agora deve incluir:

   ```json
   {
     "IsEncrypted": false,
     "Values": {
       "AzureWebJobsStorage": "UseDevelopmentStorage=true",
       "FUNCTIONS_WORKER_RUNTIME": "dotnet",
       "StorageConnectionString": "[TEST VALUE]"
     }
   }
   ```

1. Selecione **Salvar** para salvar as alterações no arquivo **local.settings.json**.

1. No painel **Explorer** da janela do **Visual Studio Code**, abra o arquivo **FileParser.cs**.

1. No editor de código, exclua todo o conteúdo.

1. Adicione o código a seguir ao arquivo **FileParser.cs**:

   ```csharp
   using Microsoft.AspNetCore.Mvc;
   using Microsoft.Azure.WebJobs;
   using Microsoft.AspNetCore.Http;
   using System;
   using System.Threading.Tasks;
   public static class FileParser
   {
        /* Append an attribute to the Run method of type FunctionNameAttribute
           that has its name parameter set to a value of FileParser */
       [FunctionName("FileParser")]
       public static async Task<IActionResult> Run(
            /* Append an attribute to the request parameter of type  HttpTriggerAttribute
            that has its methods parameter array set to a single value of GET */
           [HttpTrigger("GET")] HttpRequest request)
       {
            /* Retrieve the value of the StorageConnectionString application setting by
               using the Environment.GetEnvironmentVariable method and to store the result
               in a string variable named connectionString */
           string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");

            /* Return the value of the connectionString variable as the HTTP response */
           return new OkObjectResult(connectionString);
       }
   }
   ```

1. Selecione **Salvar** para salvar as alterações no arquivo **FileParser.cs**.

#### Tarefa 4: Validar a função local

1. Na barra de tarefas, selecione o ícone **Terminal do Windows**.

1. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

1. Execute o seguinte comando para executar o projeto de aplicativo de funções:

   ```powershell
   func start --build
   ```

   > **Observação**: Você pode examinar a documentação para [start the function app project locally][azure-functions-core-tools-start-function] usando **Azure Functions Core Tools**.

1. Na barra de tarefas, selecione o ícone **Terminal do Windows** novamente para abrir uma nova instância do aplicativo **Terminal do Windows**. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

1. Quando receber o prompt de comando aberto, execute o seguinte comando para iniciar a ferramenta **httprepl**, definindo o URI (Uniform Resource Identifier) básico como `http://localhost:7071`:

   ```powershell
   httprepl http://localhost:7071
   ```

   > **Observação**: Uma mensagem de erro é exibida pela ferramenta **httprepl**. Essa mensagem ocorre porque a ferramenta está pesquisando um arquivo de definição Swagger a ser usado para passar pela API. Como seu projeto de função não produz um arquivo de definição Swagger, você precisará passar pela API manualmente.

1. Quando receber o prompt da ferramenta, execute o seguinte comando para navegar até o diretório **api** relativo:

   ```powershell
   cd api
   ```

1. Execute o seguinte comando para navegar até o diretório **fileparser** relativo:

   ```powershell
   cd fileparser
   ```

1. Execute o seguinte comando para executar o comando **get**:

   ```powershell
   get
   ```

1. Observe o valor **[TEST VALUE]** de **StorageConnectionString** devolvido como resultado da solicitação HTTP:

   ```powershell
   HTTP/1.1 200 OK
   Content-Type: text/plain; charset=utf-8
   Date: Tue, 01 Sep 2020 23:35:39 GMT
   Server: Kestrel
   Transfer-Encoding: chunked
   [TEST VALUE]
   ```

1. Execute o seguinte comando para sair da ferramenta **httprepl**:

   ```powershell
   exit
   ```

1. Feche todas as instâncias do aplicativo **Terminal do Windows** em execução no momento.

#### Tarefa 5: Implantar a função usando Azure Functions Core Tools

1. Na barra de tarefas, selecione o ícone **Terminal do Windows**.

1. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

1. Execute o seguinte comando para entrar na interface de linha de comando (CLI) do Azure:

   ```powershell
   az login
   ```

1. Na janela do navegador do **Microsoft Edge**, insira o endereço de email e a senha da sua conta Microsoft e selecione **Entrar**.

1. Volte para a janela do **Terminal do Windows** aberta no momento. Aguarde a conclusão do processo de credenciais.

1. Execute o seguinte comando para publicar o projeto de aplicativo de funções (mude o espaço reservado `<function-app-name>` para o nome do aplicativo de funções criado anteriormente neste laboratório):

   ```powershell
   func azure functionapp publish <function-app-name>
   ```

   > **Observação**: Por exemplo, se o **nome do aplicativo de funções** for **securefuncstudent**, o comando será `func azure functionapp publish securefuncstudent`. Você pode examinar a documentação para [publish the local function app project][azure-functions-core-tools-publish-azure] usando **Azure Functions Core Tools**.

1. Aguarde o término da implantação antes de avançar neste laboratório.

1. Feche o aplicativo **Terminal do Windows** em execução no momento.

#### Tarefa 6: Testar a configuração de aplicativo derivado do Key Vault

1. Na barra de tarefas, selecione o ícone **Microsoft Edge** e, em seguida, selecione a guia que contém o portal do Azure.

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o aplicativo de funções **securefunc[yourname]**.

1. Na folha **Aplicativo de funções**, selecione a opção **Visão Geral**.

1. Na guia **Funções**na parte inferior da página de visão geral, selecione a função **FileParser**.

1. Na folha **Função**, selecione a opção **Codificar + Testar** da seção **Desenvolvedor**.

1. No editor de funções, selecione **Testar/Executar**.

1. No painel exibido automaticamente, na lista**Método HTTP**, selecione **GET**.

1. Selecione **Executar** para testar a função.

1. Examine os resultados do teste executado. O resultado deve ser sua cadeia de conexão de armazenamento do Azure.

#### Revisão

Neste exercício, você usou uma identidade de serviço para ler o valor de um segredo armazenado no Key Vault e devolveu esse valor como o resultado de um aplicativo de funções.

### Exercício 4: Acessar dados de Armazenamento de Blobs do Azure

#### Tarefa 1: carregar uma amostra de blob de armazenamento

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione a conta de armazenamento **securestor**_[yourname]_.

1. Na folha **Conta de armazenamento**, selecione o link **Contêineres** na seção **Armazenamento de dados**.

1. Na seção **Contêineres**, selecione **+ Contêiner**.

1. Na janela pop-up **Novo contêiner**, realize as seguintes ações e selecione **Criar**:

   | Configuração                                | Ação                                   |
   | -------------------------------------- | ---------------------------------------- |
   | Caixa de texto **Nome**                      | Insira**soltar**                           |
   | Lista suspensa **Nível de acesso público** | Selecionar **Particular (sem acesso anônimo)** |

1. Volte para a seção **Contêineres** e selecione o contêiner **soltar** recém-criado.

1. Na folha **Contêiner**, selecione **Carregar**.

1. Na janela **Carregar blob**, realize as seguintes ações e selecione **Carregar**:

   | Configuração                                        | Ação                                                                                                               |
   | ---------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
   | Seção **Arquivos**                              | Selecionar **Procurar arquivos** ou usar o recurso de arrastar e soltar                                                         |
   | Janela **Explorador de Arquivos**                       | Navegue até **Allfiles (F):\\Allfiles\\Labs\\07\\Starter**, selecione o arquivo **records.json** e, então, selecione **Abrir** |
   | Caixa de seleção **Substituir se arquivos já existirem** | Verificar se essa caixa de seleção está marcada                                                                               |

   > **Observação**: aguarde o carregamento do blob antes de continuar com este laboratório.

1. Retorne à folha **Contêiner** e selecione o blob **records.json** na lista de blobs.

1. Na folha **Blob**, localize os metadados do blob e copie a URL para o blob.

1. Na barra de tarefas, ative o menu de atalho para o ícone do **Microsoft Edge** e selecione **Nova janela**.

1. Na nova janela do navegador, consulte a URL que você copiou para o blob.

1. Uma mensagem de erro indicando que o recurso não foi encontrado deve ser exibida agora.

   > **Observação**: Isso é esperado, pois nosso contêiner é particular.

#### Tarefa 2: Transferir e configurar o SDK do Azure para .NET

1. Na barra de tarefas, selecione o ícone **Terminal do Windows**.

1. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

1. Execute o seguinte comando para adicionar a versão **12.12.0** do pacote **Azure.Storage.Blobs** do NuGet:

   ```powershell
   dotnet add package Azure.Storage.Blobs --version 12.12.0
   ```

   > **Observação**: O pacote [Azure.Storage.Blobs](https://www.nuget.org/packages/Azure.Storage.Blobs) do NuGet referencia o subconjunto do SDK do Azure para .NET necessário para gravar código para Armazenamento de Blobs do Azure.

1. Feche o aplicativo **Terminal do Windows** em execução no momento.

1. Na tela **inicial**, selecione o bloco **Visual Studio Code**.

1. No menu **Arquivo**, selecione **Abrir Pasta**.

1. Na janela **Explorador de Arquivos** que se abre, navegue até **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func** e selecione **Selecionar Pasta**.

1. No painel **Explorer** da janela do **Visual Studio Code**, abra o arquivo **FileParser.cs**.

1. Adicione uma **diretiva de uso** para o namespace **Azure.Storage.Blobs**:

   ```csharp
   using Azure.Storage.Blobs;
   ```

1. Examine o conteúdo do arquivo **FileParser.cs**, que agora deve incluir:

   ```csharp
   using Azure.Storage.Blobs;
   using Microsoft.AspNetCore.Mvc;
   using Microsoft.Azure.WebJobs;
   using Microsoft.AspNetCore.Http;
   using System;
   using System.Threading.Tasks;
   public static class FileParser
   {
       [FunctionName("FileParser")]
       public static async Task<IActionResult> Run(
           [HttpTrigger("GET")] HttpRequest request)
       {
           string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
           return new OkObjectResult(connectionString);
       }
   }
   ```

#### Tarefa 3: Gravar código do Armazenamento de Blobs do Azure usando o SDK do Azure para .NET

1. Atualize o conteúdo do arquivo **FileParser.cs** com o código a seguir:

   ```csharp
   using Azure.Storage.Blobs;
   using Microsoft.AspNetCore.Mvc;
   using Microsoft.Azure.WebJobs;
   using Microsoft.AspNetCore.Http;
   using System;
   using System.Threading.Tasks;
   public static class FileParser
   {
       [FunctionName("FileParser")]
       public static async Task<IActionResult> Run(
           [HttpTrigger("GET")] HttpRequest request)
       {
           string connectionString = Environment.GetEnvironmentVariable("StorageConnectionString");
           /* Create a new instance of the BlobClient class by passing in your
              connectionString variable, a  "drop" string value, and a
              "records.json" string value to the constructor */
           BlobClient blob = new BlobClient(connectionString, "drop", "records.json");

           /* Use the BlobClient.DownloadAsync method to download the contents of
              the referenced blob asynchronously, and then store the result in
              a variable named "response" */
           var response = await blob.DownloadAsync();

            /* Return the value of the various content stored in the content
               variable by using the FileStreamResult class constructor */
           return new FileStreamResult(response?.Value?.Content, response?.Value?.ContentType);
       }
   }
   ```

1. Selecione **Salvar** para salvar as alterações no arquivo **FileParser.cs**.

#### Tarefa 4: Implantar e validar o aplicativo Azure Functions

1. Na barra de tarefas, selecione o ícone **Terminal do Windows**.

1. Execute o seguinte comando para alterar o diretório atual para o diretório vazio **Allfiles (F):\\Allfiles\\Labs\\07\\Starter\\func**:

   ```powershell
   cd F:\Allfiles\Labs\07\Starter\func
   ```

1. Execute o seguinte comando para entrar na CLI do Azure:

   ```powershell
   az login
   ```

1. Na janela do navegador do **Microsoft Edge**, insira o endereço de email e a senha da sua conta Microsoft e selecione **Entrar**.

1. Volte para a janela do **Terminal do Windows** aberta no momento. Aguarde a conclusão do processo de credenciais.

1. Execute o seguinte comando para publicar o projeto de aplicativo de funções (mude o espaço reservado `<function-app-name>` para o nome do aplicativo de funções usado anteriormente neste laboratório):

   ```powershell
   func azure functionapp publish <function-app-name>
   ```

   > **Observação**: Por exemplo, se o **nome do aplicativo de funções** for **securefuncstudent**, o comando será `func azure functionapp publish securefuncstudent`. Você pode examinar a documentação para [publish the local function app project][azure-functions-core-tools-publish-azure] usando **Azure Functions Core Tools**.

1. Aguarde o término da implantação antes de avançar neste laboratório.

1. Feche o aplicativo **Terminal do Windows** em execução no momento.

1. Na barra de tarefas, selecione o ícone do **Microsoft Edge** e, em seguida, consulte o portal do Azure.

1. No painel de navegação do portal do Azure, selecione o link **Grupos de recursos**.

1. Na folha **Grupos de recursos**, selecione o grupo de recursos **ConfidentialStack**.

1. Na folha **ConfidentialStack**, selecione o aplicativo de funções **securefunc[yourname]**.

1. Na folha **Aplicativo de funções**, selecione a opção **Visão Geral**.

1. Na guia **Funções** da página de visão geral, selecione a função **FileParser** existente.

1. Na folha **Função**, selecione a opção **Codificar + Testar** da seção **Desenvolvedor**.

1. No editor de funções, selecione **Testar/Executar**.

1. No painel exibido automaticamente, na lista**Método HTTP**, selecione **GET**.

1. Selecione **Executar** para testar a função.

1. Examine os resultados do teste executado. A saída conterá o conteúdo do blob **$/drop/records.json** armazenado em sua conta de armazenamento do Azure.

#### Revisão

Neste exercício, você usou o código \# C para acessar uma conta de armazenamento e, em seguida, baixou o conteúdo de um blob.
